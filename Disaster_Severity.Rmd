---
title: "Disaster Severity"
subtitle: "Hamish Patten and Ignacio Acosta"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    css: styles.css
---

<style type="text/css">
h1.title {
  font-size: 50px;
  color: White;
}
h3.subtitle {
  font-size: 20px;
  color: White;
}
<!-- .table-hover > tbody > tr:hover { -->
<!--   background-color: #f7f7e6; -->
<!-- } -->
.main-container {
  width: 95%;
    <!-- max-width: unset; -->
  }
</style>

<div style= "position:relative">
<!-- <div style= "float:left; position:relative; top:-100px;margin-bottom:-100px;margin-left:-10px;"> -->

```{r setup, include=FALSE}
# Setup the local environment
source("./RCode/Setup/GetPackages.R")
source("./RCode/Data_Wrangling/GetFAOSTAT.R")
# Some extras for nice and neat tables
knitr::opts_chunk$set(echo = TRUE)
options(kableExtra.latex.load_packages = FALSE,
        knitr.kable.NA = '')
# Read in the Desinventar data
if(file.exists("./Data/RawData/Desinventar.RData")){
  dessie <- readRDS("./Data/RawData/Desinventar.RData")
} else {
  stop("Please download the pre-processed Desinventar data from https://unfao-my.sharepoint.com/:u:/g/personal/hamish_patten_fao_org/EcG--VZWS3RBnzLKL7lcm9IBjmVVYHhr3qpJQr8FjtIxCA?e=7Cxa1v")
}
# Extract the crop-only losses into a new dataframe
croppies<-dessie%<>%filter(!is.na(damages_in_crops_ha))
# Labels for the hazard codes
haz_Ab_lab<-c("AV"="Avalanche",
              "CW"="Cold Wave",
              "DR"="Drought",
              "EQ"="Earthquake",
              "EP"="Epidemic",
              "ER"="Erosion",
              "EC"="Extra-Tropical Cyclone",
              "ET"="Extreme Temperature",
              "FR"="Fire",
              "FF"="Flash Flood",
              "FL"="Flood",
              "HW"="Heat Wave",
              "HT"="High Temperature",
              "IN"="Insect Infestation",
              "LS"="Landslide",
              "MM"="Mass Movement",
              "MS"="Mudslide",
              "SL"="Slide",
              "SN"="Snowfall",
              "ST"="Storm",
              "SS"="Storm Surge",
              "TO"="Tornado",
              "TC"="Tropical Cyclone",
              "TS"="Tsunami",
              "WF"="Wildfire",
              "VW"="Violent Wind",
              "VO"="Volcanic Activity",
              "WV"="Wave",
              "WA"="Wave Action")

haz_Ab_lab_df <- data.frame(
  Code = names(haz_Ab_lab),
  Hazard = as.character(haz_Ab_lab),
  stringsAsFactors = FALSE
)

# Convert ISO3Cs to continent
convIso3Continent<-function(iso3){
  continents<-countrycode::countrycode(sourcevar = iso3,
                                       origin = "iso3c",
                                       destination = "continent",warn = F)
}

 # Regions
IsoContinentRegion <- read_excel("Data/Taxonomies/IsoContinentRegion.xlsx")

```

</div>

## Desinventar Data

The DesInventar database is a comprehensive disaster information system designed to systematically document and analyse the impacts of natural hazards at the subnational level. Developed by the United Nations Office for Disaster Risk Reduction (UNDRR) and other partners, it provides historical records of disasters across many different countries around the world. Each country, territory or country cluster present in Desinventar is responsible for curating, producing and managing disaster impact records, thus governments are the database custodians. The database is built on standardised methodologies, ensuring comparability of disaster impacts across time and regions. Its primary objective is to support disaster risk management, policy development, and research by offering granular, locally reported data on the effects of natural hazards on communities, infrastructure, and livelihoods. By systematically collecting and organising these diverse impact types, DesInventar serves as a valuable tool for disaster risk reduction planning and the implementation of frameworks such as the Sendai Framework for Disaster Risk Reduction and the Sustainable Development Goals (SDGs). It enables policymakers and researchers to identify trends, assess vulnerabilities, and design more effective strategies for resilience-building. DesInventar categorises disaster impacts into multiple dimensions, capturing both direct and indirect consequences. The data includes human impacts, such as the number of fatalities and injured persons. It also records economic losses, damage to built environment and productive sectors. It provides measures of agricultural impacts in the form of crop losses in hectares and livestock losses, which are critical for understanding food security risks. 

The Desinventar impact database is the only database to contain historical estimates of crop and livestock loss and damage across the globe. Please note that only 93 countries, territories and country clusters are present in the Desinventar databases, with almost all of these countries having ceased to update their national databases with new records since roughly 2016. The Desinventar data is integrated into this work because it can be used to estimate the correlations between different impact types when another impact type is not present: to correlate crop losses with economic costs or deaths, for example. However, care must be taken in order to adjust for bias that can be present across countries, continents, hazard types, impact types and time-periods.

## Ignacio Support

Ignacio, please will you analyse the Desinventar data via the following plots?

### Bias Analysis

We need to analyse bias in the data, so let's check out the following:

* Table of number of Desinventar records with crop and cattle losses per country (thus three columns)

```{r records, message=FALSE,warning=FALSE, echo=FALSE}
dessie%>%
  group_by(ISO3) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
kableExtra::kable(
  col.names = c(
    "Country - ISO3",
    "Crop records",
    "Livestock records"
    )
  )
``` 


* Barplot of number of Desinventar records with crop and cattle losses by region

```{r barplot_reg, message=FALSE,warning=FALSE, echo=FALSE}
dessie%>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  filter(
    !is.na(Region)
  )%>%
  group_by(Region) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = reorder(Region,-Crop_Info),
      y = Crop_Info
    )
  )+
  geom_bar(
    stat = "identity",
    fill = "#5b9dcf"
  ) +
  labs(
        x = "Region",
        y = "Number of registers",
        title = "Number of desinventar records associated to crops by region"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 

dessie%>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  filter(
    !is.na(Region)
  )%>%
  group_by(Region) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = reorder(Region,-Animals_Info),
      y = Animals_Info
    )
  )+
  geom_bar(
    stat = "identity",
    fill = "#5b9dcf"
  ) +
  labs(
        x = "Region",
        y = "Number of registers",
        title = "Number of desinventar records associated to animals by region"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 

dessie%>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  filter(
    !is.na(Region)
  )%>%
  group_by(Region) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  pivot_longer(
    Crop_Info:Animals_Info,
    names_to = "Concept",
    values_to = "Records"
  )%>%
  ggplot(
    aes(
      x = reorder(Region,-Records),
      y = Records,
      fill = Concept
    )
  )+
  geom_bar(
    stat = "identity",
    position = "dodge"
  ) +
  labs(
        x = "Region",
        y = "Number of registers",
        title = "Number of desinventar records associated to animals/crop by region"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 12, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        axis.text.x  = element_text(size = 7)
      ) 
```

* Barplot of number of Desinventar records with crop and cattle losses per hazard type (use haz_Ab)

```{r barplot_haz, message=FALSE,warning=FALSE, echo=FALSE}
dessie%>%
  group_by(haz_Ab) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = reorder(haz_Ab,-Crop_Info),
      y = Crop_Info
    )
  )+
  geom_bar(
    stat = "identity",
    fill = "#5b9dcf"
  ) +
  labs(
        x = "Hazard",
        y = "Number of registers",
        title = "Number of desinventar records associated to crops by hazard"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 

dessie%>%
  group_by(haz_Ab) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = reorder(haz_Ab,-Animals_Info),
      y = Animals_Info
    )
  )+
  geom_bar(
    stat = "identity",
    fill = "#5b9dcf"
  ) +
  labs(
        x = "Hazard",
        y = "Number of registers",
        title = "Number of desinventar records associated to animals by hazard"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 

dessie%>%
  group_by(haz_Ab) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  pivot_longer(
    Crop_Info:Animals_Info,
    names_to = "Concept",
    values_to = "Records"
  )%>%
  ggplot(
    aes(
      x = reorder(haz_Ab,-Records),
      y = Records,
      fill = Concept
    )
  )+
  geom_bar(
    stat = "identity",
    position = "dodge"
  ) +
  labs(
        x = "Region",
        y = "Number of registers",
        title = "Number of desinventar records associated to animals/crop by haz"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 12, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        axis.text.x  = element_text(size = 7)
      ) 
```

* Point plot of number of Desinventar records with crop and cattle losses in time

```{r time, message=FALSE,warning=FALSE, echo=FALSE}
dessie%>%
  mutate(
    Year = lubridate::year(date),
    Year = case_when(
      Year == 2103 ~ 2013,
      Year == 2104 ~ 2014,
      Year == 2202 ~ 2022,
      TRUE ~ Year
    )
  )%>%
  filter(
    Year >= 1990
  )%>%
  group_by(Year) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = Year,
      y = Crop_Info
    )
  )+
  geom_point(
    colour = "black", size = 1
  ) +
  geom_line(
    size = 1, alpha = 0.6,color = "#5b9dcf"
  )+
  labs(
        x = "Year",
        y = "Number of registers",
        title = "Number of desinventar records associated to crops by year"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "bottom"
      ) 

dessie%>%
  mutate(
    Year = lubridate::year(date),
    Year = case_when(
      Year == 2103 ~ 2013,
      Year == 2104 ~ 2014,
      Year == 2202 ~ 2022,
      TRUE ~ Year
    )
  )%>%
  filter(
    Year >= 1990
  )%>%
  group_by(Year) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  ggplot(
    aes(
      x = Year,
      y = Animals_Info
    )
  )+
  geom_point(
    colour = "black", size = 1
  ) +
  geom_line(
    size = 1, alpha = 0.6,color = "#5b9dcf"
  )+
  labs(
        x = "Year",
        y = "Number of registers",
        title = "Number of desinventar records associated to animals by year"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "bottom"
      ) 

dessie%>%
  mutate(
    Year = lubridate::year(date),
    Year = case_when(
      Year == 2103 ~ 2013,
      Year == 2104 ~ 2014,
      Year == 2202 ~ 2022,
      TRUE ~ Year
    )
  )%>%
  filter(
    Year >= 1990
  )%>%
  group_by(Year) %>%
  summarise(
    Crop_Info = sum(!is.na(damages_in_crops_ha)), 
    Animals_Info = sum(!is.na(lost_cattle))
  )%>%
  pivot_longer(
    Crop_Info:Animals_Info,
    names_to = "Concept",
    values_to = "Registers"
  )%>%
  ggplot(
    aes(
      x = Year,
      y = Registers,
      colour = Concept
    )
  )+
  geom_point(
    colour = "black", size = 1
  ) +
  geom_line(
    size = 1, alpha = 0.6
  )+
  labs(
        x = "Year",
        y = "Number of registers",
        title = "Number of desinventar records associated to crops/animals by year"
      )  +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "bottom"
      ) 

```

### Intra-Impact Correlations

Now we need to analyse the correlation between different impact types, grouping them wherever possible to ensure sufficient sample sizes. When plotting economic losses, please plot the impact estimated in USD and not the local/unknown currency.

```{r economics, message=FALSE,warning=FALSE, echo=FALSE}
# We need to convert LCU to USD and then, deflate USD values to 2017.

ER <- GetFAOSTAT_ER(1990,NULL)
CPI_USD_2017 <- GetCPI_USA(1990,NULL)

Economic <- dessie%>%
  mutate(
    Year = lubridate::year(date),
    Year = case_when(
      Year == 2103 ~ 2013,
      Year == 2104 ~ 2014,
      Year == 2202 ~ 2022,
      TRUE ~ Year
    )
  )%>%
  filter(
    Year >= 1990
  )%>%
  left_join(
    ER,
    by = c("ISO3" = "ISO3.CODE","Year" = "Year")
  )%>%
  left_join(
    CPI_USD_2017,
    by = "Year"
  )%>%
  mutate(
    USD_2017 = case_when(
      !is.na(losses_in_dollar) ~ losses_in_dollar/CPI_2017,
      is.na(losses_in_dollar) & !is.na(losses_local_currency) ~ losses_local_currency/(CPI_2017*ER),
      TRUE ~ NA
    )
  )%>%
  filter(
    !is.na(USD_2017)
  )
```

From the 40072 registers recorder from 1990 onwards, 4198 have economic losses data.

* Point plot of crop losses against: deaths, economic losses, directly affected, indirectly affected, injured and missing

```{r economics2, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "Monetary losses (2017 USD)",
        title = "Lost ha. vs monetary losses on agriculture due to disasters"
      ) +
      scale_y_continuous(
        labels = function(x) paste0(x / 1e9, " bill.")
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    
Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(Monetary losses (2017 USD))",
        title = "Lost ha. vs monetary losses on agriculture due to disasters",
        subtitle = "Logarithmic scale"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+
  scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se=FALSE)
```

```{r economics3, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = deaths
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "Deaths",
        title = "Lost ha. vs number of deaths"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = deaths
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(Deaths)",
        subtitle = "Logarithmic scale",
        title = "Lost ha. vs number of deaths"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()
    
```
```{r economics4, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = directly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "directly affected",
        title = "Lost ha. vs directly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = directly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(directly affected)",
        subtitle = "Logarithmic scale",
        title = "Lost ha. vs directly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```
```{r economics5, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = indirectly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "indirectly affected",
        title = "Lost ha. vs indirectly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = indirectly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(indirectly affected)",
        subtitle = "Logarithmic scale",
        title = "Lost ha. vs indirectly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```
```{r economics6, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = injured
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "injured",
        title = "Lost ha. vs injured"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = injured
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(injured)",
        subtitle = "Logarithmic scale",
        title = "Lost ha. vs injured"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```

```{r economics7, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = missing
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "missing",
        title = "Lost ha. vs missing"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = missing
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(missing)",
        subtitle = "Logarithmic scale",
        title = "Lost ha. vs missing"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()
    
```

* Point plot of crop losses against economic losses by disaster type (using haz_Ab)
```{r economics8, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  left_join(
    haz_Ab_lab_df,
    by = c("haz_Ab" = "Code")
  )%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "Monetary losses (2017 USD)",
        title = "Lost ha. vs monetary losses on agriculture due to disasters"
      ) +
      scale_y_continuous(
        labels = function(x) paste0(x / 1e9, " bill.")
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+facet_wrap(~Hazard) 
    
Economic%>%
  left_join(
    haz_Ab_lab_df,
    by = c("haz_Ab" = "Code")
  )%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(Monetary losses (2017 USD))",
        title = "Lost ha. vs monetary losses on agriculture due to disasters",
        subtitle = "Logarithmic scale"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+
  scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se=FALSE)+
  facet_wrap(~Hazard)
```
* Point plot of crop losses against economic losses by  UN regions

```{r economics9, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost ha. (crops)",
        y = "Monetary losses (2017 USD)",
        title = "Lost ha. vs monetary losses on agriculture due to disasters"
      ) +
      scale_y_continuous(
        labels = function(x) paste0(x / 1e9, " bill.")
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+facet_wrap(~Region) 
    
Economic%>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  ggplot(
    aes(
      x = damages_in_crops_ha,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost ha. (crops))",
        y = "Log(Monetary losses (2017 USD))",
        title = "Lost ha. vs monetary losses on agriculture due to disasters",
        subtitle = "Logarithmic scale"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+
  scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se=FALSE)+
  facet_wrap(~Region) 
```

* Table of adj-R-squared values of all impact types against crop losses by disaster type (using haz_Ab), include sample size

```{r Rsq, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table <- Economic %>%
  group_by(haz_Ab) %>%
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(USD_2017 ~ damages_in_crops_ha))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table%>%
kableExtra::kable(col.names = c("Abbreviated Hazard","Sample size","R2-Adj"))
```

* Table of adj-R-squared values of all impact types against crop losses by UN region, include sample size
```{r Rsq2, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table2 <- Economic %>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  group_by(Region) %>%
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(USD_2017 ~ damages_in_crops_ha))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table2%>%
kableExtra::kable(col.names = c("UN Region","Sample size","R2-Adj"))
```

* Table of adj-R-squared values of all impact types against crop losses by UN region (IN LOGARITHM), include sample size
```{r Rsq2log, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table2 <- Economic %>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  group_by(Region) %>%
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(log(USD_2017) ~ log(damages_in_crops_ha)))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table2%>%
kableExtra::kable(col.names = c("UN Region","Sample size","R2-Adj"))
```
* All of the above but for cattle losses instead of crop losses

* Point plot of crop losses against: deaths, economic losses, directly affected, indirectly affected, injured and missing

```{r economics2b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "Monetary losses (2017 USD)",
        title = "Lost cattle vs monetary losses on agriculture due to disasters"
      ) +
      scale_y_continuous(
        labels = function(x) paste0(x / 1e9, " bill.")
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    
Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = USD_2017
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle)",
        y = "Log(Monetary losses (2017 USD))",
        title = "Lost cattle vs monetary losses on agriculture due to disasters",
        subtitle = "Logarithmic scale"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      )+
  scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se=FALSE)
```

```{r economics3b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = deaths
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "Deaths",
        title = "Lost cattle vs number of deaths"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = deaths
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle)",
        y = "Log(Deaths)",
        subtitle = "Logarithmic scale",
        title = "Lost cattle vs number of deaths"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()
    
```
```{r economics4b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = directly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "directly affected",
        title = "Lost cattle vs directly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = directly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle)",
        y = "Log(directly affected)",
        subtitle = "Logarithmic scale",
        title = "Lost cattle vs directly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```
```{r economics5b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = indirectly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "indirectly affected",
        title = "Lost cattle vs indirectly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = indirectly_affected
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle (crops))",
        y = "Log(indirectly affected)",
        subtitle = "Logarithmic scale",
        title = "Lost cattle vs indirectly affected"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```
```{r economics6b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = injured
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "injured",
        title = "Lost cattle vs injured"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = injured
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle)",
        y = "Log(injured)",
        subtitle = "Logarithmic scale",
        title = "Lost cattle vs injured"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()+
  geom_smooth(colour = "red",se = FALSE)
    
```

```{r economics7b, message=FALSE,warning=FALSE, echo=FALSE}

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = missing
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Lost cattle",
        y = "missing",
        title = "Lost cattle vs missing"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) 
    

Economic%>%
  ggplot(
    aes(
      x = lost_cattle,
      y = missing
    )
  ) +
      geom_point(colour = "black", size = 2,alpha=0.3) +
      geom_hline(yintercept = 0, colour = "red", size = 1, alpha = 0.7) +
      labs(
        x = "Log(Lost cattle)",
        y = "Log(missing)",
        subtitle = "Logarithmic scale",
        title = "Lost cattle vs missing"
      ) +
      theme(
        plot.title = element_text(family = "Arial", size = 15, face = "bold", color = "#5b9dcf"),
        axis.text = element_text(family = "Arial", size = 10),
        axis.title = element_text(family = "Arial", size = 11),
        axis.line = element_line(color = "black"),
        legend.position = "none"
      ) +
    scale_y_log10()+
  scale_x_log10()
    
```

* Table of adj-R-squared values of all impact types against crop losses by disaster type (using haz_Ab), include sample size

```{r Rsqb, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table <- Economic %>%
  group_by(haz_Ab) %>%
  filter(sum(!is.na(USD_2017) & !is.na(lost_cattle)) > 1)%>% 
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(USD_2017 ~ lost_cattle))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table%>%
kableExtra::kable(col.names = c("Abbreviated Hazard","Sample size","R2-Adj"))
```


* Table of adj-R-squared values of all impact types against crop losses by UN region, include sample size
```{r Rsq2b, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table2 <- Economic %>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  group_by(Region) %>%
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(USD_2017 ~ lost_cattle))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table2%>%
kableExtra::kable(col.names = c("UN Region","Sample size","R2-Adj"))
```


* Table of adj-R-squared values of all impact types against crop losses by UN region (IN LOGARITHM), include sample size
```{r Rsq2logb, message=FALSE,warning=FALSE, echo=FALSE}
adj_r2_table2 <- Economic %>%
  left_join(
    IsoContinentRegion%>%
      rename(
        Region = 'UN Region',
        ISO3 = 'ISO Code'
      )%>%
      select(
        Region,
        ISO3
      ),
    by = "ISO3"
  )%>%
  group_by(Region) %>%
  summarise(
    n = n(),  
    adj_r2 = ifelse(n() > 1, summary(lm(log(USD_2017) ~ log(lost_cattle)))$adj.r.squared, NA_real_)
  ) %>%
  arrange(desc(adj_r2)) 

adj_r2_table2%>%
kableExtra::kable(col.names = c("UN Region","Sample size","R2-Adj"))
```


* Re-group certain hazards based on differences and then make a table of adj-R-squared values of all impact types against crop losses by grouped disaster types, include sample size
* Normalise the crop losses in the Desinventar database with the productive cropland area from FAOSTAT, then re-calculate the hazard type (using haz_Ab) adj-R-squared values, make table
* Same as above but with grouped-hazard types, trying different grouping methods
* Now normalise by country area instead of cropland area (country area can be extracted from the World Bank database and then left_joined to the IsoContinentRegion file), as well as normalising each impact type by their obvious variable (e.g. deaths by country population, economic cost by GDP, both of which can be extracted from the World Bank database) and recalculate the hazard type adj-R-squared values, make table
* (Not sure about this one) Re-weight, using three progressive levels of scale of the weighting, every record such that countries that record more disasters with crop losses are given less weight, then recalculate the adj-R-squared values
* Try many formulations of the above but for quantiles instead of the actual impact value

### Disaster Severity Models

Let's try out modelling this! For this first model attempt we only need point estimates, but in future we should include uncertainty and covariates into the model (e.g. UN subregion or hazard type).
* Linear and log-linear model for things like economic cost and affected persons and maybe a negative binomial for deaths? Deaths is the hard one...
* Try converting from impact values into quantile-space, then fitting models such as multivariate normal on deaths, economic losses and others?
* Try out mixtures of linear, log-linear, quantile-linear and multivariate quantile models
* GPR, ensuring that the model also spits out uncertainty values

<br><br>

Examples of plots and tables in RMarkdown:

```{r haz_Ab, message=FALSE,warning=FALSE, echo=FALSE}

table(dessie$haz_Ab)%>%as.data.frame()%>%
  arrange(desc(Freq))%>%
kableExtra::kable(col.names = c("Abbreviated Hazard","Number of Records"))

```

<br><br>

```{r isos, message=FALSE,warning=FALSE, echo=FALSE}

table(dessie$ISO3)%>%as.data.frame()%>%
  arrange(desc(Freq))%>%
kableExtra::kable(col.names = c("Country/Cluster ISO","Number of Records"))

```

<br><br>



```{r plots, message=FALSE,warning=FALSE, echo=FALSE}

p<-dessie%>%filter(haz_Ab%in%c("DR","FL","TC","ST","EQ","WF"))%>%
    ggplot()+geom_point(aes(damages_in_crops_ha,deaths,colour=haz_Ab))+
    ggtitle("Correlation deaths and crops [Ha]")+
    scale_y_log10()+scale_x_log10()+facet_wrap(~haz_Ab)
  
q<-dessie%>%filter(haz_Ab%in%c("DR","FL","TC","ST","EQ","WF"))%>%
    ggplot()+geom_point(aes(damages_in_crops_ha,losses_in_dollar,colour=haz_Ab))+
    ggtitle("Correlation economic loss [USD] and crops [Ha]")+
    scale_y_log10()+scale_x_log10()+facet_wrap(~haz_Ab)

gridExtra::grid.arrange(p,q, ncol=2)

```

<br><br>